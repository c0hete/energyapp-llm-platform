{% extends "base.html" %}

{% block title %}Configuraci√≥n - EnergyApp LLM{% endblock %}

{% block header_info %}{{ user.email }}{% endblock %}

{% block extra_styles %}
<style>
  .config-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
  }

  @media (max-width: 768px) {
    .config-grid {
      grid-template-columns: 1fr;
    }
  }

  .config-section {
    background: var(--panel-strong);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 20px;
    box-shadow: var(--shadow);
  }

  .config-section h2 {
    margin: 0 0 16px;
    font-size: 18px;
  }

  .setting-item {
    margin-bottom: 16px;
  }

  .setting-item label {
    display: block;
    margin-bottom: 6px;
  }

  .setting-item input,
  .setting-item select {
    width: 100%;
  }

  .slider-container {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .slider-container input[type="range"] {
    flex: 1;
  }

  .slider-value {
    min-width: 50px;
    text-align: right;
    font-family: monospace;
  }

  .button-group {
    display: flex;
    gap: 8px;
    margin-top: 16px;
  }

  .button-group button {
    flex: 1;
  }

  .test-result {
    padding: 10px;
    border-radius: 8px;
    margin-top: 8px;
    font-size: 12px;
  }

  .test-result.success {
    background: rgba(81, 207, 102, 0.1);
    border: 1px solid var(--success);
    color: var(--success);
  }

  .test-result.error {
    background: rgba(255, 107, 107, 0.1);
    border: 1px solid var(--error);
    color: var(--error);
  }

  .info-text {
    font-size: 12px;
    color: var(--muted);
    margin-top: 4px;
  }

  .back-button {
    margin-bottom: 16px;
  }

  #passwordModal {
    display: none !important;
  }

  #passwordModal.show {
    display: flex !important;
  }
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1000px; margin: 0 auto;">
  <div class="back-button">
    <button class="ghost" onclick="window.location.href='/dashboard'">‚Üê Volver al Chat</button>
  </div>

  <h1 style="margin-bottom: 24px;">Configuraci√≥n</h1>

  <div class="config-grid">
    <!-- Configuraci√≥n de Modelo -->
    <div class="config-section">
      <h2>‚öô Par√°metros del Modelo</h2>

      <div class="setting-item">
        <label>Temperatura (creatividad)</label>
        <div class="slider-container">
          <input type="range" id="temperature" min="0" max="1" step="0.1" value="{{ settings.ollama_temperature }}" />
          <span class="slider-value" id="tempValue">{{ settings.ollama_temperature }}</span>
        </div>
        <p class="info-text">Valores bajos = respuestas m√°s predecibles. Altos = m√°s creativas</p>
      </div>

      <div class="setting-item">
        <label>Top P (diversidad)</label>
        <div class="slider-container">
          <input type="range" id="topP" min="0" max="1" step="0.1" value="{{ settings.ollama_top_p }}" />
          <span class="slider-value" id="topPValue">{{ settings.ollama_top_p }}</span>
        </div>
        <p class="info-text">Controla la diversidad de tokens seleccionados</p>
      </div>

      <div class="setting-item">
        <label>M√°ximo de Tokens</label>
        <input type="number" id="maxTokens" min="64" max="4096" value="{{ settings.ollama_max_tokens }}" />
        <p class="info-text">Longitud m√°xima de la respuesta</p>
      </div>
    </div>

    <!-- Estado del Sistema -->
    <div class="config-section">
      <h2>üîç Sistema</h2>

      <div class="setting-item">
        <h3 style="margin:0 0 12px; font-size:14px;">Servidor Ollama</h3>
        <p class="muted" style="margin:0 0 8px; font-size:12px;">{{ settings.ollama_host }}</p>
        <p class="muted" style="margin:0 0 12px; font-size:12px;">Modelo: {{ settings.ollama_model }}</p>
        <button onclick="testOllama()">Test Conexi√≥n</button>
        <div id="ollamaResult"></div>
      </div>
    </div>

    <!-- Perfil de Usuario -->
    <div class="config-section">
      <h2>üë§ Perfil</h2>

      <div class="setting-item">
        <label>Email</label>
        <input type="email" value="{{ user.email }}" disabled />
      </div>

      <div class="setting-item">
        <label>Rol</label>
        <input type="text" value="{{ user.role }}" disabled />
      </div>

      <div class="button-group">
        <button onclick="changePassword()">Cambiar Contrase√±a</button>
        <button class="ghost" onclick="window.location.href='/auth/logout'">Logout</button>
      </div>
    </div>

    <!-- Sesiones Activas -->
    <div class="config-section">
      <h2>üîê Sesiones</h2>
      <p class="info-text" style="margin-bottom:12px;">Gestiona tus dispositivos y sesiones activas</p>
      <button onclick="loadSessions()">Mostrar Sesiones</button>
      <div id="sessionsList"></div>
    </div>
  </div>
</div>

<!-- Modal de cambio de contrase√±a -->
<div id="passwordModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); align-items:center; justify-content:center; z-index:100;">
  <div class="block" style="max-width:400px; width:100%; margin:20px;">
    <h2>Cambiar Contrase√±a</h2>
    <div class="setting-item">
      <label>Contrase√±a Actual</label>
      <input type="password" id="currentPassword" />
    </div>
    <div class="setting-item">
      <label>Nueva Contrase√±a</label>
      <input type="password" id="newPassword" />
    </div>
    <div class="setting-item">
      <label>Confirmar Contrase√±a</label>
      <input type="password" id="confirmPassword" />
    </div>
    <div class="button-group">
      <button onclick="submitPasswordChange()">Cambiar</button>
      <button class="ghost" onclick="closePasswordModal()">Cancelar</button>
    </div>
    <div id="passwordStatus"></div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
  // Actualizar sliders
  document.getElementById('temperature').addEventListener('input', (e) => {
    document.getElementById('tempValue').textContent = e.target.value;
  });

  document.getElementById('topP').addEventListener('input', (e) => {
    document.getElementById('topPValue').textContent = e.target.value;
  });

  async function testOllama() {
    const result = document.getElementById('ollamaResult');
    result.innerHTML = '<span class="status">Probando...</span>';

    try {
      const res = await jsonFetch('/config/test-ollama', 'POST');
      result.innerHTML = `<div class="test-result success">‚úì ${res.message}</div>`;
    } catch (err) {
      result.innerHTML = `<div class="test-result error">‚úó ${err.message}</div>`;
    }
  }

  function changePassword() {
    document.getElementById('passwordModal').classList.add('show');
  }

  function closePasswordModal() {
    document.getElementById('passwordModal').classList.remove('show');
    document.getElementById('currentPassword').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
  }

  async function submitPasswordChange() {
    const current = document.getElementById('currentPassword').value;
    const newPass = document.getElementById('newPassword').value;
    const confirm = document.getElementById('confirmPassword').value;
    const status = document.getElementById('passwordStatus');

    if (newPass !== confirm) {
      status.innerHTML = '<div class="test-result error">‚ùå Las contrase√±as no coinciden</div>';
      return;
    }

    if (newPass.length < 6) {
      status.innerHTML = '<div class="test-result error">‚ùå La contrase√±a debe tener al menos 6 caracteres</div>';
      return;
    }

    try {
      await jsonFetch('/auth/change-password', 'POST', {
        current_password: current,
        new_password: newPass
      });
      status.innerHTML = '<div class="test-result success">‚úì Contrase√±a cambiada exitosamente</div>';
      setTimeout(() => closePasswordModal(), 1500);
    } catch (err) {
      status.innerHTML = `<div class="test-result error">‚úó ${err.message}</div>`;
    }
  }

  async function loadSessions() {
    const list = document.getElementById('sessionsList');
    list.innerHTML = '<span class="status">Cargando sesiones...</span>';

    try {
      // Por ahora mostramos un mensaje (la API de sesiones se completar√° en pr√≥xima fase)
      list.innerHTML = '<p class="info-text">Las sesiones activas se mostrar√°n aqu√≠</p>';
    } catch (err) {
      list.innerHTML = `<div class="test-result error">Error: ${err.message}</div>`;
    }
  }
</script>
{% endblock %}
