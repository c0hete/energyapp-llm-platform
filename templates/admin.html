{% extends "base.html" %}

{% block title %}Panel Admin - EnergyApp LLM{% endblock %}

{% block header_info %}Admin - {{ user.email }}{% endblock %}

{% block extra_styles %}
<style>
  .admin-panel {
    display: grid;
    grid-template-columns: 250px 1fr 350px;
    gap: 16px;
    min-height: calc(100vh - 200px);
  }

  @media (max-width: 1024px) {
    .admin-panel {
      grid-template-columns: 1fr;
    }
  }

  .admin-column {
    background: var(--panel-strong);
    border: 1px solid var(--border);
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .admin-column h3 {
    padding: 12px 16px;
    margin: 0;
    border-bottom: 1px solid var(--border);
    font-size: 14px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .admin-list {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }

  .admin-item {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 13px;
  }

  .admin-item:hover {
    background: var(--bg-alt);
  }

  .admin-item.active {
    background: var(--accent);
    color: #fff;
  }

  .admin-item strong {
    display: block;
    margin-bottom: 4px;
  }

  .admin-item .meta {
    font-size: 11px;
    opacity: 0.7;
  }

  .admin-item.active .meta {
    opacity: 0.9;
  }

  .admin-content {
    padding: 16px;
    overflow-y: auto;
  }

  .msg {
    padding: 12px;
    margin-bottom: 8px;
    border-radius: 8px;
    border-left: 4px solid var(--accent);
  }

  .msg.assistant {
    background: var(--bg-alt);
    border-left-color: #51cf66;
  }

  .msg.user {
    background: rgba(31, 100, 255, 0.1);
    border-left-color: var(--accent);
  }

  .msg .meta {
    font-size: 11px;
    color: var(--muted);
    margin-bottom: 4px;
    text-transform: uppercase;
    font-weight: 600;
  }

  .reassign-section {
    border-top: 1px solid var(--border);
    padding-top: 12px;
    margin-top: 12px;
  }

  .reassign-section label {
    display: block;
    font-size: 12px;
    margin-bottom: 6px;
    color: var(--muted);
  }

  .reassign-section select {
    width: 100%;
    margin-bottom: 8px;
  }

  .reassign-section button {
    width: 100%;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }

  @media (max-width: 1024px) {
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .stats-grid {
      grid-template-columns: 1fr;
    }
  }

  .stat-card {
    background: var(--panel-strong);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    text-align: center;
  }

  .stat-value {
    font-size: 32px;
    font-weight: bold;
    color: var(--accent);
    margin: 8px 0;
  }

  .stat-label {
    color: var(--muted);
    font-size: 12px;
  }

  .back-button {
    margin-bottom: 16px;
  }

  .muted {
    color: var(--muted);
    font-size: 12px;
  }

  .welcome {
    text-align: center;
    padding: 40px 20px;
    color: var(--muted);
  }
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto;">
  <div class="back-button">
    <button class="ghost" onclick="window.location.href='/dashboard'">‚Üê Volver al Chat</button>
  </div>

  <h1 style="margin-bottom: 24px;">üë®‚Äçüíº Panel de Administraci√≥n</h1>

  <!-- Estad√≠sticas -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">Usuarios Totales</div>
      <div class="stat-value" id="activeUsersCount">{{ user_count }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Conversaciones</div>
      <div class="stat-value" id="conversationsCount">{{ conversation_count }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Mensajes</div>
      <div class="stat-value" id="messagesCount">{{ message_count }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Sesiones Activas</div>
      <div class="stat-value" id="sessionsCount">{{ session_count }}</div>
    </div>
  </div>

  <!-- Admin Panel: 3-column Interactive Layout -->
  <div class="admin-panel">
    <!-- Left Column: Users List -->
    <div class="admin-column">
      <h3>üë• Usuarios</h3>
      <div class="admin-list" id="adminUserList">
        {% for u in users %}
        <div class="admin-item" data-id="{{ u.id }}" data-email="{{ u.email }}">
          <strong>{{ u.email }}</strong>
          <div class="meta">{{ u.role }}</div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Middle Column: Conversations List -->
    <div class="admin-column">
      <h3>üí¨ Conversaciones</h3>
      <div class="admin-list" id="adminConvList">
        <div class="muted" style="padding: 16px; text-align: center;">Selecciona un usuario</div>
      </div>
    </div>

    <!-- Right Column: Messages Viewer & Reassign -->
    <div class="admin-column">
      <h3>üìù Mensajes</h3>
      <div class="admin-content" id="adminMessages">
        <div class="welcome">Selecciona una conversaci√≥n</div>
      </div>
      <div class="reassign-section">
        <label for="reassignSelect">Reasignar a:</label>
        <select id="reassignSelect"></select>
        <button onclick="reassignConversation()">Reasignar</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
  let adminSelectedUserId = null;
  let adminSelectedConvId = null;

  // Initialize user list interactions
  document.querySelectorAll('#adminUserList .admin-item').forEach(item => {
    item.addEventListener('click', (e) => {
      const userId = item.dataset.id;
      const email = item.dataset.email;

      // Update active state
      document.querySelectorAll('#adminUserList .admin-item').forEach(el => el.classList.remove('active'));
      item.classList.add('active');

      // Load conversations for this user
      adminSelectedUserId = userId;
      adminSelectedConvId = null;
      loadAdminConversations(userId);
      renderReassignOptions(userId);

      // Clear messages
      document.getElementById('adminMessages').innerHTML = '<div class="welcome">Selecciona una conversaci√≥n</div>';
    });
  });

  async function loadAdminConversations(userId) {
    const container = document.getElementById('adminConvList');
    container.innerHTML = '<div class="muted" style="padding: 16px; text-align: center;">Cargando...</div>';

    try {
      const res = await fetch(`/admin/conversations?user_id=${userId}`);
      if (!res.ok) throw new Error('Failed to load conversations');

      const convs = await res.json();

      if (convs.length === 0) {
        container.innerHTML = '<div class="muted" style="padding: 16px; text-align: center;">Sin conversaciones</div>';
        return;
      }

      container.innerHTML = '';
      convs.forEach(conv => {
        const div = document.createElement('div');
        div.className = 'admin-item';
        div.dataset.id = conv.id;
        div.innerHTML = `<strong>${conv.title || 'Sin t√≠tulo'}</strong><div class="meta">${new Date(conv.created_at).toLocaleDateString('es-ES')}</div>`;

        div.addEventListener('click', () => {
          adminSelectedConvId = conv.id;
          document.querySelectorAll('#adminConvList .admin-item').forEach(el => el.classList.remove('active'));
          div.classList.add('active');
          loadAdminMessages(conv.id);
        });

        container.appendChild(div);
      });
    } catch (err) {
      container.innerHTML = `<div class="muted" style="padding: 16px; text-align: center;">Error: ${err.message}</div>`;
    }
  }

  async function loadAdminMessages(conversationId) {
    const container = document.getElementById('adminMessages');
    container.innerHTML = '<div class="welcome">Cargando mensajes...</div>';

    try {
      const res = await fetch(`/admin/conversations/${conversationId}/messages?limit=400`);
      if (!res.ok) throw new Error('Failed to load messages');

      const messages = await res.json();

      if (messages.length === 0) {
        container.innerHTML = '<div class="welcome">Sin mensajes en esta conversaci√≥n</div>';
        return;
      }

      container.innerHTML = '';
      messages.forEach(msg => {
        const div = document.createElement('div');
        div.className = `msg ${msg.role}`;
        div.innerHTML = `
          <div class="meta">${msg.role === 'user' ? 'Usuario' : 'Asistente'}</div>
          <div>${msg.content}</div>
        `;
        container.appendChild(div);
      });

      // Scroll to bottom
      container.scrollTop = container.scrollHeight;
    } catch (err) {
      container.innerHTML = `<div class="muted" style="padding: 16px;">Error: ${err.message}</div>`;
    }
  }

  async function renderReassignOptions(currentUserId) {
    const select = document.getElementById('reassignSelect');
    select.innerHTML = '<option value="">Seleccionar usuario...</option>';

    try {
      const res = await fetch(`/admin/users`);
      if (!res.ok) throw new Error('Failed to load users');

      const users = await res.json();
      users
        .filter(u => u.id != currentUserId)
        .forEach(u => {
          const opt = document.createElement('option');
          opt.value = u.id;
          opt.textContent = u.email;
          select.appendChild(opt);
        });
    } catch (err) {
      console.error('Error loading users for reassign:', err);
    }
  }

  async function reassignConversation() {
    if (!adminSelectedConvId || !adminSelectedUserId) {
      alert('Selecciona una conversaci√≥n primero');
      return;
    }

    const targetUserId = document.getElementById('reassignSelect').value;
    if (!targetUserId) {
      alert('Selecciona un usuario destino');
      return;
    }

    try {
      const res = await fetch(`/admin/conversations/${adminSelectedConvId}/reassign`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ target_user_id: targetUserId })
      });

      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.detail || 'Reassign failed');
      }

      alert('Conversaci√≥n reasignada exitosamente');

      // Reload conversations
      if (adminSelectedUserId) {
        loadAdminConversations(adminSelectedUserId);
      }
    } catch (err) {
      alert(`Error: ${err.message}`);
    }
  }
</script>
{% endblock %}
