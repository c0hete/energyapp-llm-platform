{% extends "base.html" %}

{% block title %}Login - EnergyApp LLM{% endblock %}

{% block extra_styles %}
<style>
  main {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: calc(100vh - 60px);
    padding: 32px 18px;
  }

  .login-container {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 20px;
    max-width: 800px;
    width: 100%;
    align-items: start;
  }

  @media (max-width: 768px) {
    .login-container {
      grid-template-columns: 1fr;
    }
    .qr-section {
      display: none;
    }
  }

  .login-form {
    background: var(--panel-strong);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 24px;
    box-shadow: var(--shadow);
  }

  .login-form h1 {
    margin: 0 0 24px;
    font-size: 24px;
    text-align: center;
  }

  .login-form .logo {
    display: flex;
    justify-content: center;
    margin-bottom: 16px;
  }

  .login-form .logo img {
    height: 60px;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-group label {
    display: block;
    margin-bottom: 6px;
  }

  .form-group input {
    width: 100%;
  }

  .form-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .form-actions button {
    width: 100%;
    padding: 12px;
  }

  .quick-access {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
  }

  .quick-access .label {
    display: block;
    margin-bottom: 8px;
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
  }

  .quick-buttons {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 6px;
    margin-bottom: 8px;
  }

  .quick-buttons button {
    font-size: 12px;
    padding: 8px;
  }

  .qr-section {
    background: var(--panel-strong);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 16px;
    box-shadow: var(--shadow);
  }

  .qr-section h3 {
    margin: 0 0 12px;
    font-size: 14px;
    text-align: center;
  }

  .qr-section .warning {
    background: rgba(255, 152, 0, 0.1);
    border: 1px solid #ff9800;
    border-radius: 4px;
    padding: 8px;
    margin-bottom: 12px;
    font-size: 11px;
    color: #ff9800;
    line-height: 1.4;
  }

  .qr-display {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 280px;
    height: 280px;
    padding: 8px;
    background: var(--bg);
    border-radius: 8px;
    margin-bottom: 12px;
  }

  .qr-display img {
    max-width: 100%;
    max-height: 100%;
  }

  .qr-secret {
    font-family: monospace;
    font-size: 10px;
    word-break: break-all;
    padding: 8px;
    background: var(--bg);
    border-radius: 4px;
    border: 1px solid var(--border);
    max-height: 60px;
    overflow-y: auto;
    line-height: 1.4;
    margin-top: 8px;
  }

  .status-message {
    margin-top: 12px;
    padding: 10px;
    border-radius: 8px;
    font-size: 13px;
    text-align: center;
  }

  .status-message.error {
    background: rgba(255, 107, 107, 0.1);
    border: 1px solid var(--error);
    color: var(--error);
  }

  .status-message.success {
    background: rgba(81, 207, 102, 0.1);
    border: 1px solid var(--success);
    color: var(--success);
  }
</style>
{% endblock %}

{% block content %}
<div class="login-container">
  <!-- Formulario de Login -->
  <div class="login-form">
    <div class="logo">
      <img src="/static/logo.png" alt="logo" />
    </div>
    <h1>Inicia Sesión</h1>

    <form id="loginForm">
      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" required />
      </div>

      <div class="form-group">
        <label for="password">Contraseña</label>
        <input type="password" id="password" name="password" required />
      </div>

      <div class="form-actions">
        <button type="submit" id="btnLogin">Inicia Sesión</button>
        <button type="button" class="ghost" onclick="showRegister()">Crear Cuenta</button>
      </div>

      <div id="loginStatus"></div>
    </form>

    <!-- Sección de Acceso Rápido -->
    <div class="quick-access">
      <div class="label">Acceso Rápido - Cuentas Demo</div>
      <div class="quick-buttons">
        <button onclick="fillQuick('administrador@alvaradomazzei.cl', 'admin123')" class="ghost">Admin</button>
        <button onclick="fillQuick('trabajador@alvaradomazzei.cl', 'worker123')" class="ghost">Trabajador</button>
        <button onclick="fillQuick('supervisor@alvaradomazzei.cl', 'supervisor123')" class="ghost">Supervisor</button>
      </div>
    </div>
  </div>

  <!-- Sección QR (2FA Demo) -->
  <div class="qr-section" id="qrSection" style="display:none;">
    <h3>Credencial de Demo 2FA</h3>
    <div class="warning">
      Escanea para autenticarte con una cuenta de prueba que tenga 2FA habilitado
    </div>
    <div class="qr-display" id="qrDisplay">
      <span class="muted">Cargando QR...</span>
    </div>
    <div class="qr-secret" id="qrSecret" style="display:none;"></div>
  </div>
</div>

<!-- Modal 2FA -->
<div id="twoFAModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:100;">
  <div class="block" style="max-width:400px; width:100%; margin:20px;">
    <h2>Verificación 2FA</h2>
    <p class="muted">Ingresa el código de tu app autenticadora</p>
    <div class="form-group">
      <input type="text" id="totpCode" placeholder="000000" maxlength="6" inputmode="numeric" style="text-align:center; font-size:24px; letter-spacing:8px;" />
    </div>
    <div class="form-actions">
      <button type="submit" id="btnVerify2FA">Verificar</button>
      <button type="button" class="ghost" onclick="cancel2FA()">Cancelar</button>
    </div>
    <div id="twoFAStatus"></div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
  let sessionToken = null;
  let demoQRs = {};

  // Cargar QRs de demo al iniciar la página
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      const res = await jsonFetch('/auth/demo-qr-codes');
      if (res.demo_qrs && res.demo_qrs.length > 0) {
        // Crear mapa de email -> QR data
        res.demo_qrs.forEach(qr => {
          demoQRs[qr.email] = qr;
        });
      }
    } catch (err) {
      console.error('Error cargando QRs demo:', err);
    }
  });

  // Llenar campos rápidos con cuentas demo y mostrar QR
  function fillQuick(email, password) {
    document.getElementById('email').value = email;
    document.getElementById('password').value = password;

    // Mostrar QR de la cuenta demo si existe
    if (demoQRs[email]) {
      const qrData = demoQRs[email];
      const qrSection = document.getElementById('qrSection');
      const qrDisplay = document.getElementById('qrDisplay');
      const qrSecret = document.getElementById('qrSecret');

      // Mostrar QR
      qrDisplay.innerHTML = `
        <div style="text-align: center;">
          <img src="data:image/svg+xml;base64,${qrData.qr_code}" style="max-width: 200px; margin: 0 auto;" />
        </div>
      `;

      // Mostrar secret y instrucciones
      qrSecret.innerHTML = `
        <div style="margin-top: 16px;">
          <p><strong>Código manual (si no puedes escanear):</strong></p>
          <code style="display: block; padding: 10px; background: var(--bg-alt); border-radius: 6px; word-break: break-all; margin: 8px 0;">${qrData.secret}</code>
          <p style="font-size: 13px; color: var(--muted); margin-top: 12px;">
            1. Descarga <strong>Google Authenticator</strong>, <strong>Microsoft Authenticator</strong>, <strong>Authy</strong> o similar<br>
            2. Escanea el código QR arriba o ingresa el código manualmente<br>
            3. Copia el código de 6 dígitos que aparece en tu app<br>
            4. Ingresa el código en el campo de verificación al hacer login
          </p>
        </div>
      `;

      qrSecret.style.display = 'block';
      qrSection.style.display = 'block';

      // Scroll hacia el QR
      qrSection.scrollIntoView({ behavior: 'smooth' });
    }
  }

  // Mostrar formulario de registro
  function showRegister() {
    const email = document.getElementById('email').value;
    if (email) {
      window.location.href = `/register?email=${encodeURIComponent(email)}`;
    } else {
      window.location.href = '/register';
    }
  }

  // Enviar login
  document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const statusDiv = document.getElementById('loginStatus');

    try {
      const res = await jsonFetch('/auth/login', 'POST', { email, password });

      if (res.needs_2fa) {
        // Mostrar modal 2FA
        sessionToken = res.session_token;
        document.getElementById('twoFAModal').style.display = 'flex';
        document.getElementById('totpCode').focus();
      } else {
        // Login exitoso sin 2FA
        statusDiv.innerHTML = '<div class="status-message success">✓ Iniciando sesión...</div>';
        setTimeout(() => window.location.href = '/dashboard', 500);
      }
    } catch (err) {
      statusDiv.innerHTML = `<div class="status-message error">❌ ${err.message}</div>`;
    }
  });

  // Verificar 2FA
  document.getElementById('btnVerify2FA').addEventListener('click', async () => {
    const totpCode = document.getElementById('totpCode').value;
    const statusDiv = document.getElementById('twoFAStatus');

    if (!totpCode) {
      statusDiv.innerHTML = '<div class="status-message error">❌ Ingresa el código</div>';
      return;
    }

    try {
      await jsonFetch('/auth/verify-2fa', 'POST', {
        session_token: sessionToken,
        totp_code: totpCode
      });

      statusDiv.innerHTML = '<div class="status-message success">✓ 2FA verificado, iniciando sesión...</div>';
      setTimeout(() => window.location.href = '/dashboard', 500);
    } catch (err) {
      statusDiv.innerHTML = `<div class="status-message error">❌ ${err.message}</div>`;
      document.getElementById('totpCode').value = '';
    }
  });

  function cancel2FA() {
    document.getElementById('twoFAModal').style.display = 'none';
    document.getElementById('totpCode').value = '';
    sessionToken = null;
  }
</script>
{% endblock %}
