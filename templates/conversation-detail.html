{% extends "base.html" %}

{% block title %}{{ conversation.title }} - EnergyApp LLM{% endblock %}

{% block header_info %}{{ user.email }} - {{ conversation.title }}{% endblock %}

{% block extra_styles %}
<style>
  main {
    display: flex;
    flex-direction: column;
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
    min-height: calc(100vh - 60px);
  }

  .conv-header {
    padding: 16px;
    background: var(--panel-strong);
    border: 1px solid var(--border);
    border-radius: 14px;
    margin-bottom: 20px;
    box-shadow: var(--shadow);
  }

  .conv-header h1 {
    margin: 0 0 8px;
    font-size: 24px;
  }

  .conv-meta {
    display: flex;
    gap: 20px;
    font-size: 12px;
    color: var(--muted);
  }

  .status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    background: rgba(81, 207, 102, 0.2);
    color: var(--success);
  }

  .status-closed {
    background: rgba(255, 107, 107, 0.2);
    color: var(--error);
  }

  .status-archived {
    background: rgba(168, 168, 168, 0.2);
    color: var(--muted);
  }

  .messages-container {
    flex: 1;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 16px;
    margin-bottom: 20px;
    overflow-y: auto;
    max-height: 500px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    box-shadow: var(--shadow);
  }

  .message {
    padding: 12px 14px;
    border-radius: 10px;
    max-width: 80%;
    word-wrap: break-word;
    line-height: 1.4;
    font-size: 14px;
  }

  .message.user {
    align-self: flex-end;
    background: var(--accent);
    color: white;
  }

  .message.assistant {
    align-self: flex-start;
    background: var(--bg-alt);
    border: 1px solid var(--border);
    color: var(--text);
  }

  .message-timestamp {
    font-size: 11px;
    opacity: 0.7;
    margin-top: 4px;
  }

  .empty-messages {
    text-align: center;
    color: var(--muted);
    padding: 40px 20px;
  }

  .input-section {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .input-section textarea {
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 10px;
    background: var(--bg);
    color: var(--text);
    font-family: inherit;
    font-size: 14px;
    resize: vertical;
    min-height: 80px;
  }

  .input-section textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(31, 100, 255, 0.1);
  }

  .button-row {
    display: flex;
    gap: 8px;
  }

  .button-row button {
    flex: 1;
  }

  .back-button {
    margin-bottom: 16px;
  }

  .actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }

  .action-btn {
    padding: 8px 14px;
    background: var(--bg-alt);
    border: 1px solid var(--border);
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s ease;
  }

  .action-btn:hover {
    background: var(--panel);
    border-color: var(--accent);
  }

  @media (max-width: 768px) {
    .message {
      max-width: 95%;
    }

    .conv-meta {
      flex-wrap: wrap;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="back-button">
  <button class="ghost" onclick="window.location.href='/conversations'">← Volver a conversaciones</button>
</div>

<div class="conv-header">
  <h1>{{ conversation.title }}</h1>
  <div class="conv-meta">
    <div>
      <strong>Estado:</strong>
      <span class="status-badge {% if conversation.status != 'open' %}status-{{ conversation.status }}{% endif %}">
        {{ conversation.status }}
      </span>
    </div>
    <div><strong>Creada:</strong> {{ conversation.created_at.strftime('%d/%m/%Y %H:%M') }}</div>
    <div><strong>Mensajes:</strong> {{ messages|length }}</div>
  </div>
  <div class="actions">
    <button class="action-btn" onclick="editConversation()">Editar</button>
    <button class="action-btn" onclick="deleteConversation()" style="color: var(--error);">Borrar</button>
  </div>
</div>

<div class="messages-container">
  {% if messages %}
    {% for msg in messages %}
    <div class="message {{ msg.role }}">
      <div>{{ msg.content }}</div>
      <div class="message-timestamp">{{ msg.created_at.strftime('%d/%m %H:%M') }}</div>
    </div>
    {% endfor %}
  {% else %}
  <div class="empty-messages">
    <p>No hay mensajes aún en esta conversación</p>
    <p style="font-size: 12px;">Comienza escribiendo tu primer mensaje abajo</p>
  </div>
  {% endif %}
</div>

<form class="input-section" onsubmit="submitMessage(event)">
  <textarea id="messageInput" name="content" placeholder="Escribe tu mensaje..." required></textarea>
  <div class="button-row">
    <button type="submit">Enviar Mensaje</button>
    <button type="button" class="ghost" onclick="window.location.href='/conversations'">Volver</button>
  </div>
  <div id="messageStatus"></div>
</form>

<!-- Modal para editar conversación -->
<div id="editModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:100;">
  <div class="block" style="max-width:400px; width:100%; margin:20px;">
    <h2>Editar Conversación</h2>
    <div style="margin-bottom:16px;">
      <label>Título</label>
      <input type="text" id="editConvTitle" value="{{ conversation.title }}" />
    </div>
    <div style="margin-bottom:16px;">
      <label>Estado</label>
      <select id="editConvStatus">
        <option value="open" {% if conversation.status == 'open' %}selected{% endif %}>Abierta</option>
        <option value="closed" {% if conversation.status == 'closed' %}selected{% endif %}>Cerrada</option>
        <option value="archived" {% if conversation.status == 'archived' %}selected{% endif %}>Archivada</option>
      </select>
    </div>
    <div style="display:flex; gap:8px;">
      <button onclick="submitEditConversation()">Guardar</button>
      <button class="ghost" onclick="closeEditModal()">Cancelar</button>
    </div>
    <div id="editStatus" style="margin-top:12px;"></div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  const conversationId = {{ conversation.id }};

  function editConversation() {
    document.getElementById('editModal').style.display = 'flex';
  }

  function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    document.getElementById('editStatus').innerHTML = '';
  }

  async function submitEditConversation() {
    const title = document.getElementById('editConvTitle').value.trim();
    const status = document.getElementById('editConvStatus').value;
    const statusDiv = document.getElementById('editStatus');

    if (!title) {
      statusDiv.innerHTML = '<div class="test-result error">❌ El título no puede estar vacío</div>';
      return;
    }

    try {
      await jsonFetch(`/conversations/${conversationId}`, 'PUT', { title, status });
      statusDiv.innerHTML = '<div class="test-result success">✓ Conversación actualizada, recargando...</div>';
      setTimeout(() => window.location.reload(), 1000);
    } catch (err) {
      statusDiv.innerHTML = `<div class="test-result error">✗ ${err.message}</div>`;
    }
  }

  async function submitMessage(e) {
    e.preventDefault();
    const content = document.getElementById('messageInput').value.trim();
    const statusDiv = document.getElementById('messageStatus');

    if (!content) {
      statusDiv.innerHTML = '<div class="test-result error">❌ El mensaje no puede estar vacío</div>';
      return;
    }

    try {
      statusDiv.innerHTML = '<div class="status">Enviando...</div>';
      await jsonFetch('/chat', 'POST', {
        conversation_id: conversationId,
        prompt: content,
        system: ''
      });
      statusDiv.innerHTML = '<div class="test-result success">✓ Mensaje enviado, recargando...</div>';
      setTimeout(() => window.location.reload(), 1000);
    } catch (err) {
      statusDiv.innerHTML = `<div class="test-result error">✗ ${err.message}</div>`;
    }
  }

  async function deleteConversation() {
    if (!confirm('¿Estás seguro que deseas borrar esta conversación? Esta acción no se puede deshacer.')) {
      return;
    }

    try {
      await jsonFetch(`/conversations/${conversationId}`, 'DELETE');
      alert('✓ Conversación borrada');
      window.location.href = '/conversations';
    } catch (err) {
      alert(`✗ Error al borrar: ${err.message}`);
    }
  }
</script>
{% endblock %}
