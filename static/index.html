<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EnergyApp LLM Chat</title>
  <link rel="icon" type="image/png" href="/static/favicon.png" />
  <style>
    :root {
      --bg: #0b1220;
      --panel: #0f172a;
      --accent: #1f64ff;
      --border: #1f2a44;
      --muted: #a7b3ce;
      --text: #f5f7fb;
    }
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--text); }
    header { background: #11192c; padding: 12px 16px; font-weight: 600; display: flex; align-items: center; gap: 12px; position: sticky; top: 0; z-index: 5; }
    header .brand { font-size: 16px; display: flex; align-items: center; gap: 8px; }
    header .brand img { height: 32px; width: auto; }
    main { display: grid; grid-template-columns: 320px 0; height: calc(100vh - 48px); transition: grid-template-columns 0.2s ease; }
    main.authed { grid-template-columns: 280px 1fr; }
    aside { border-right: 1px solid var(--border); background: #0d1424; padding: 14px; display: flex; flex-direction: column; gap: 12px; overflow: hidden; }
    .block { border: 1px solid var(--border); border-radius: 8px; padding: 10px; background: var(--panel); }
    label { display: block; margin-bottom: 6px; font-size: 13px; color: var(--muted); }
    input, button, textarea { width: 100%; border-radius: 6px; border: 1px solid var(--border); background: var(--panel); color: var(--text); padding: 10px; }
    button { cursor: pointer; font-weight: 600; background: var(--accent); border: none; }
    button.ghost { background: #2a3348; }
    button:hover { background: #1b56d9; }
    textarea { min-height: 90px; resize: vertical; }
    .conv-list { flex: 1; overflow: auto; margin-top: 8px; }
    .conv-item { padding: 8px; border-radius: 6px; cursor: pointer; border: 1px solid transparent; margin-bottom: 6px; display: flex; align-items: center; gap: 8px; }
    .conv-item:hover { border-color: var(--border); }
    .conv-item.active { border-color: var(--accent); background: #14213d; }
    .conv-title { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .conv-delete { width: 28px; padding: 6px; background: #2a3348; border: 1px solid var(--border); border-radius: 6px; }
    .content { padding: 16px; display: flex; flex-direction: column; gap: 12px; height: calc(100vh - 48px); }
    .tabs { display: none; gap: 8px; margin-bottom: 8px; }
    .tabs.visible { display: flex; }
    .tabs button { background: #1a2237; border: 1px solid var(--border); padding: 8px 12px; border-radius: 6px; color: var(--text); }
    .tabs button.active { background: var(--accent); border-color: var(--accent); }
    .section { display: none; }
    .section.active { display: flex; flex-direction: column; gap: 10px; flex: 1; }
    .chat-header { font-size: 14px; color: var(--muted); }
    .chat-box { flex: 1; border: 1px solid var(--border); border-radius: 8px; padding: 12px; background: var(--panel); overflow: auto; min-height: 320px; }
    .msg { margin-bottom: 12px; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word; }
    .msg.user { color: #a7b3ce; font-size: 13px; }
    .msg.assistant { color: #f5f7fb; }
    .prompt-area { border: 1px solid var(--border); border-radius: 8px; padding: 10px; background: var(--panel); display: flex; flex-direction: column; gap: 8px; }
    .muted { color: var(--muted); font-size: 13px; }
    .hidden { display: none !important; }
    .full-height { flex: 1; display: flex; flex-direction: column; min-height: 0; }
    .status { font-size: 12px; color: var(--muted); text-align: right; }
    .welcome { color: var(--muted); font-size: 14px; margin-top: 12px; }
  </style>
</head>
<body>
  <header>
    <div class="brand"><img src="/static/logo.png" alt="logo" /><span>EnergyApp LLM Chat</span></div>
  </header>

  <main id="layout" class="unauth">
    <aside>
      <div id="loginBlock" class="block">
        <label for="email">Email</label>
        <input id="email" type="email" value="admin@example.com" />
        <label for="password">Password</label>
        <input id="password" type="password" value="admin123" />
        <button id="btnLogin" style="margin-top:8px;">Login</button>
        <button id="btnDemoAdmin" class="ghost" style="margin-top:6px;">Login demo (admin)</button>
        <div class="muted" style="margin:10px 0 6px;">Acceso rápido</div>
        <div class="row" style="display:flex; gap:8px;">
          <button id="btnFillAdmin" class="ghost" style="flex:1;">Admin</button>
          <button id="btnFillWorker" class="ghost" style="flex:1;">Trabajador</button>
          <button id="btnFillSupervisor" class="ghost" style="flex:1;">Supervisor</button>
        </div>
        <p id="loginStatus" class="muted" style="margin-top:6px;"></p>
      </div>
      <div id="convBlock" class="block hidden full-height">
        <button id="btnNewConv" style="margin-bottom:8px;">Nueva conversacion</button>
        <div class="muted" style="margin-bottom:6px;">Conversaciones recientes</div>
        <div class="conv-list" id="convList"></div>
        <div class="conv-footer" style="border-top:1px solid var(--border); padding-top:8px; margin-top:8px; flex-shrink:0;">
          <div class="muted" id="userInfo"></div>
          <button id="btnAdmin" class="ghost" style="margin-top:8px;">Perfil / Admin</button>
          <button id="btnLogout" class="ghost" style="margin-top:6px;">Logout</button>
        </div>
      </div>
    </aside>

    <section class="content hidden" id="contentShell">
      <div class="tabs" id="tabs">
        <button data-tab="chat" class="active">Chat</button>
        <button data-tab="config">Config</button>
      </div>

      <div id="chatShell" class="section active">
        <div class="chat-header" id="convTitle">Nueva conversacion</div>
        <div class="chat-box" id="chatBox"></div>
        <div class="prompt-area">
          <label for="prompt" class="muted">Prompt</label>
          <textarea id="prompt" placeholder="Escribe tu mensaje...">Hola, ¿qué puedes hacer?</textarea>
          <div class="row">
            <button id="btnSend" style="flex:1">Enviar</button>
            <button id="btnClear" class="ghost" style="width:120px;">Limpiar</button>
          </div>
          <div id="status" class="status"></div>
        </div>
      </div>

      <div id="configShell" class="section hidden">
        <div class="block">
          <h3 style="margin:0 0 6px;">Configuracion</h3>
          <p class="muted">Ollama host: <code>http://127.0.0.1:11434</code></p>
          <p class="muted">Modelo: <code>qwen2.5:3b-instruct</code></p>
          <p class="muted">JWT: access/refresh via <code>/auth/login</code> y <code>/auth/refresh</code>.</p>
        </div>
      </div>

      <div id="adminShell" class="section hidden">
        <div class="block">
          <h3 style="margin:0 0 6px;">Admin</h3>
          <p class="muted">Vista de solo lectura. Proximamente: listado de usuarios y conversaciones.</p>
        </div>
      </div>
    </section>
  </main>

  <script>
    const chatBox = document.getElementById("chatBox");
    const promptInput = document.getElementById("prompt");
    const loginStatus = document.getElementById("loginStatus");
    const userInfo = document.getElementById("userInfo");
    const btnLogout = document.getElementById("btnLogout");
    const btnAdmin = document.getElementById("btnAdmin");
    const btnDemoAdmin = document.getElementById("btnDemoAdmin");
    const btnFillAdmin = document.getElementById("btnFillAdmin");
    const btnFillWorker = document.getElementById("btnFillWorker");
    const btnFillSupervisor = document.getElementById("btnFillSupervisor");
    const loginBlock = document.getElementById("loginBlock");
    const convBlock = document.getElementById("convBlock");
    const convList = document.getElementById("convList");
    const convTitle = document.getElementById("convTitle");
    const chatShell = document.getElementById("chatShell");
    const configShell = document.getElementById("configShell");
    const adminShell = document.getElementById("adminShell");
    const tabs = document.getElementById("tabs");
    const contentShell = document.getElementById("contentShell");
    const layout = document.getElementById("layout");
    const statusEl = document.getElementById("status");
    let accessToken = "";
    let refreshToken = "";
    let currentConversationId = null;

    function append(text, isAssistant=false) {
      const msgDiv = document.createElement("div");
      msgDiv.className = `msg ${isAssistant ? "assistant" : "user"}`;
      msgDiv.innerHTML = `<strong>${isAssistant ? "Assistant:" : "User:"}</strong> ${escapeHtml(text)}`;
      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function escapeHtml(text) {
      const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    function setTab(tab) {
      document.querySelectorAll(".tabs button").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === tab);
      });
      chatShell.classList.toggle("hidden", tab !== "chat");
      configShell.classList.toggle("hidden", tab !== "config");
      adminShell.classList.toggle("hidden", tab !== "admin");
    }

    async function loadConversations() {
      if (!accessToken) return;
      try {
        const res = await fetch("/conversations?limit=50", {
          headers: { "Authorization": "Bearer " + accessToken }
        });
        if (!res.ok) return;
        const convs = await res.json();
        convList.innerHTML = "";
        convs.forEach(c => {
          const div = document.createElement("div");
          div.className = "conv-item";
          div.dataset.id = c.id;
          const span = document.createElement("span");
          span.className = "conv-title";
          span.textContent = c.title || "Sin titulo";
          const del = document.createElement("button");
          del.className = "conv-delete";
          del.textContent = "✕";
          del.addEventListener("click", (ev) => {
            ev.stopPropagation();
            deleteConversation(c.id);
          });
          div.addEventListener("click", () => setActiveConversation(c.id, c.title));
          div.append(span, del);
          convList.appendChild(div);
        });
      } catch (e) {
        console.error(e);
      }
    }

    async function loadMessages(conversationId) {
      if (!accessToken || !conversationId) return;
      try {
        const res = await fetch(`/conversations/${conversationId}/messages?limit=200`, {
          headers: { "Authorization": "Bearer " + accessToken }
        });
        if (!res.ok) return;
        const msgs = await res.json();
        chatBox.innerHTML = "";
        msgs.forEach(m => {
          append(m.content, m.role === "assistant");
        });
        if (msgs.length === 0) {
          chatBox.innerHTML = '<div class="welcome">Escribe tu primer mensaje para comenzar una nueva conversación.</div>';
        }
      } catch (e) {
        console.error(e);
      }
    }

    function setActiveConversation(id, title) {
      currentConversationId = id;
      convTitle.textContent = title || "Nueva conversacion";
      document.querySelectorAll(".conv-item").forEach(item => {
        item.classList.toggle("active", item.dataset.id === String(id));
      });
      loadMessages(id);
    }

    async function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      loginStatus.textContent = "Iniciando sesion...";
      try {
        const res = await fetch("/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });
        if (!res.ok) throw new Error("Login failed");
        const data = await res.json();
        accessToken = data.access_token;
        refreshToken = data.refresh_token;
        loginStatus.textContent = "Login OK";
        userInfo.textContent = `Logueado: ${email}`;
        setAuthedUI(true);
        await fetchProfile();
        await loadConversations();
        chatBox.innerHTML = '<div class="welcome">Escribe tu primer mensaje para comenzar una nueva conversación.</div>';
      } catch (err) {
        loginStatus.textContent = "Error de login";
        console.error(err);
      }
    }

    async function fetchProfile() {
      if (!accessToken) return;
      try {
        const res = await fetch("/auth/me", {
          headers: { "Authorization": "Bearer " + accessToken }
        });
        if (!res.ok) return;
        const me = await res.json();
        userInfo.textContent = `Logueado: ${me.email} (rol: ${me.role})`;
      } catch (e) { /* ignore */ }
    }

    async function createConversation() {
      if (!accessToken) return;
      try {
        const res = await fetch("/conversations", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + accessToken
          },
          body: JSON.stringify({ title: "Nueva conversacion" })
        });
        if (!res.ok) return;
        const conv = await res.json();
        await loadConversations();
        setActiveConversation(conv.id, conv.title);
      } catch (e) {
        console.error(e);
      }
    }

    async function sendPrompt() {
      if (!accessToken) {
        alert("Haz login primero");
        return;
      }
      const prompt = promptInput.value.trim();
      if (!prompt) return;
      if (!currentConversationId) {
        await createConversation();
      }

      // Generar título automáticamente en el primer mensaje
      const isFirstMessage = chatBox.children.length === 0 || (chatBox.children.length === 1 && chatBox.querySelector(".welcome"));
      if (isFirstMessage && currentConversationId) {
        try {
          const titleRes = await fetch(`/conversations/${currentConversationId}/generate-title`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + accessToken
            },
            body: JSON.stringify({ prompt })
          });
          if (titleRes.ok) {
            const titleData = await titleRes.json();
            convTitle.textContent = titleData.title;
            const activeItem = document.querySelector(`[data-id="${currentConversationId}"]`);
            if (activeItem) {
              const titleSpan = activeItem.querySelector(".conv-title");
              if (titleSpan) titleSpan.textContent = titleData.title;
            }
          }
        } catch (e) {
          console.error("Error generando título:", e);
        }
      }

      append(prompt, false);
      promptInput.value = "";
      setStatus("Generando respuesta...");
      document.getElementById("btnSend").disabled = true;

      const assistantMsgDiv = document.createElement("div");
      assistantMsgDiv.className = "msg assistant";
      assistantMsgDiv.innerHTML = "<strong>Assistant:</strong> ";
      chatBox.appendChild(assistantMsgDiv);

      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + accessToken
          },
          body: JSON.stringify({ prompt, conversation_id: currentConversationId })
        });
        if (!res.ok) {
          const errText = await res.text();
          append("Error: " + errText, true);
          return;
        }
        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buf = "";
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          buf += decoder.decode(value, { stream: true });
          assistantMsgDiv.innerHTML = `<strong>Assistant:</strong> ${escapeHtml(buf)}`;
          chatBox.scrollTop = chatBox.scrollHeight;
        }
      } catch (err) {
        append("Error: " + err.message, true);
      } finally {
        setStatus("");
        document.getElementById("btnSend").disabled = false;
      }
    }

    function logout() {
      accessToken = "";
      refreshToken = "";
      currentConversationId = null;
      chatBox.innerHTML = "";
      convTitle.textContent = "Nueva conversacion";
      convList.innerHTML = "";
      userInfo.textContent = "";
      setAuthedUI(false);
    }

    function setAuthedUI(isAuthed) {
      if (isAuthed) {
        loginBlock.classList.add("hidden");
        convBlock.classList.remove("hidden");
        contentShell.classList.remove("hidden");
        tabs.classList.add("visible");
        layout.classList.add("authed");
      } else {
        loginBlock.classList.remove("hidden");
        convBlock.classList.add("hidden");
        contentShell.classList.add("hidden");
        tabs.classList.remove("visible");
        layout.classList.remove("authed");
        setTab("chat");
      }
    }

    async function deleteConversation(id) {
      if (!accessToken) return;
      if (!confirm("Eliminar esta conversacion?")) return;
      try {
        const res = await fetch(`/conversations/${id}`, {
          method: "DELETE",
          headers: { "Authorization": "Bearer " + accessToken }
        });
        if (!res.ok) return;
        if (currentConversationId === id) {
          currentConversationId = null;
          chatBox.innerHTML = "";
          convTitle.textContent = "Nueva conversacion";
        }
        await loadConversations();
      } catch (e) {
        console.error(e);
      }
    }

    function setStatus(text) {
      statusEl.textContent = text || "";
    }

    document.getElementById("btnLogin").addEventListener("click", login);
    document.getElementById("btnSend").addEventListener("click", sendPrompt);
    document.getElementById("btnClear").addEventListener("click", () => { chatBox.innerHTML = ""; });
    document.getElementById("btnNewConv").addEventListener("click", () => {
      if (accessToken) {
        currentConversationId = null;
        convTitle.textContent = "Nueva conversacion";
        chatBox.innerHTML = '<div class="welcome">Escribe tu primer mensaje para comenzar una nueva conversación.</div>';
        createConversation();
      }
    });
    btnLogout.addEventListener("click", logout);
    btnAdmin.addEventListener("click", () => setTab("admin"));
    btnDemoAdmin.addEventListener("click", () => {
      document.getElementById("email").value = "admin@example.com";
      document.getElementById("password").value = "admin123";
      login();
    });
    btnFillAdmin.addEventListener("click", () => {
      document.getElementById("email").value = "admin@example.com";
      document.getElementById("password").value = "admin123";
    });
    btnFillWorker.addEventListener("click", () => {
      document.getElementById("email").value = "trabajador@example.com";
      document.getElementById("password").value = "worker123";
    });
    btnFillSupervisor.addEventListener("click", () => {
      document.getElementById("email").value = "supervisor@example.com";
      document.getElementById("password").value = "supervisor123";
    });
    document.querySelectorAll(".tabs button").forEach(btn => {
      btn.addEventListener("click", () => setTab(btn.dataset.tab));
    });
  </script>
</body>
</html>
