{% extends "base.html" %}

{% block title %}Panel Admin - EnergyApp LLM{% endblock %}

{% block header_info %}Admin - {{ user.email }}{% endblock %}

{% block extra_styles %}
<style>
  .admin-panel {
    display: grid;
    grid-template-columns: 250px 1fr 350px;
    gap: 16px;
    min-height: calc(100vh - 200px);
  }

  @media (max-width: 1024px) {
    .admin-panel {
      grid-template-columns: 1fr;
    }
  }

  .admin-column {
    background: var(--panel-strong);
    border: 1px solid var(--border);
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .admin-column h3 {
    padding: 12px 16px;
    margin: 0;
    border-bottom: 1px solid var(--border);
    font-size: 14px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .admin-subhead {
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
    color: var(--muted);
  }

  .admin-list {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }

  .admin-item {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 13px;
  }

  .admin-item:hover {
    background: var(--bg-alt);
  }

  .admin-item.active {
    background: var(--accent);
    color: #fff;
  }

  .admin-item strong {
    display: block;
    margin-bottom: 4px;
  }

  .admin-item .meta {
    font-size: 11px;
    opacity: 0.7;
  }

  .admin-item.active .meta {
    opacity: 0.9;
  }

  .admin-content {
    padding: 16px;
    overflow-y: auto;
  }

  .msg {
    padding: 12px;
    margin-bottom: 8px;
    border-radius: 8px;
    border-left: 4px solid var(--accent);
  }

  .msg.assistant {
    background: var(--bg-alt);
    border-left-color: #51cf66;
  }

  .msg.user {
    background: rgba(31, 100, 255, 0.1);
    border-left-color: var(--accent);
  }

  .msg.system {
    background: rgba(0, 0, 0, 0.04);
    border-left-color: var(--muted);
  }

  .msg .meta {
    font-size: 11px;
    color: var(--muted);
    margin-bottom: 4px;
    text-transform: uppercase;
    font-weight: 600;
  }

  .reassign-section {
    border-top: 1px solid var(--border);
    padding: 12px 16px;
    margin-top: auto;
  }

  .reassign-section label {
    display: block;
    font-size: 12px;
    margin-bottom: 6px;
    color: var(--muted);
  }

  .reassign-section select {
    width: 100%;
    margin-bottom: 8px;
  }

  .reassign-section button {
    width: 100%;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }

  @media (max-width: 1024px) {
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .stats-grid {
      grid-template-columns: 1fr;
    }
  }

  .stat-card {
    background: var(--panel-strong);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    text-align: center;
  }

  .stat-value {
    font-size: 32px;
    font-weight: bold;
    color: var(--accent);
    margin: 8px 0;
  }

  .stat-label {
    color: var(--muted);
    font-size: 12px;
  }

  .back-button {
    margin-bottom: 16px;
  }

  .muted {
    color: var(--muted);
    font-size: 12px;
  }

  .welcome {
    text-align: center;
    padding: 40px 20px;
    color: var(--muted);
  }
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto;">
  <div class="back-button">
    <button class="ghost" onclick="window.location.href='/dashboard'">← Volver al Chat</button>
  </div>

  <h1 style="margin-bottom: 24px;">Panel de Administracion</h1>

  <!-- Estadisticas -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">Usuarios Totales</div>
      <div class="stat-value" id="activeUsersCount">{{ user_count }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Conversaciones</div>
      <div class="stat-value" id="conversationsCount">{{ conversation_count }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Mensajes</div>
      <div class="stat-value" id="messagesCount">{{ message_count }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Sesiones Activas</div>
      <div class="stat-value" id="sessionsCount">{{ session_count }}</div>
    </div>
  </div>

  <!-- Admin Panel: 3-column Interactive Layout -->
  <div class="admin-panel">
    <!-- Left Column: Users List -->
    <div class="admin-column">
      <h3>Usuarios</h3>
      <div class="admin-list" id="adminUserList">
        {% for u in users %}
        <div class="admin-item" data-id="{{ u.id }}" data-email="{{ u.email }}">
          <strong>{{ u.email }}</strong>
          <div class="meta">Rol: {{ u.role }}{% if u.last_activity %} · Ultima actividad: {{ u.last_activity }}{% endif %}</div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Middle Column: Conversations List -->
    <div class="admin-column">
      <h3>Conversaciones</h3>
      <div class="admin-subhead" id="adminUserSelected">Selecciona un usuario</div>
      <div class="admin-list" id="adminConvList">
        <div class="muted" style="padding: 16px; text-align: center;">Selecciona un usuario</div>
      </div>
    </div>

    <!-- Right Column: Messages Viewer & Reassign -->
    <div class="admin-column">
      <h3>Mensajes</h3>
      <div class="admin-subhead" id="adminConvTitle">Selecciona una conversacion</div>
      <div class="admin-content" id="adminMessages">
        <div class="welcome">Selecciona una conversacion</div>
      </div>
      <div class="reassign-section">
        <label for="reassignSelect">Reasignar a:</label>
        <select id="reassignSelect"></select>
        <button onclick="reassignConversation()">Reasignar</button>
      </div>
    </div>
  </div>

  <div id="adminStatus" class="muted" style="margin-top: 12px;"></div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
  let adminSelectedUserId = null;
  let adminSelectedConvId = null;

  const adminStatus = document.getElementById('adminStatus');
  const adminUserSelected = document.getElementById('adminUserSelected');
  const adminConvTitle = document.getElementById('adminConvTitle');

  function setAdminStatus(msg) {
    adminStatus.textContent = msg || '';
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str ?? '';
    return div.innerHTML;
  }

  // Initialize user list interactions
  document.querySelectorAll('#adminUserList .admin-item').forEach(item => {
    item.addEventListener('click', () => {
      const userId = item.dataset.id;
      const email = item.dataset.email;

      document.querySelectorAll('#adminUserList .admin-item').forEach(el => el.classList.remove('active'));
      item.classList.add('active');

      adminSelectedUserId = userId;
      adminSelectedConvId = null;
      adminUserSelected.textContent = `${email} (id ${userId})`;
      adminConvTitle.textContent = 'Selecciona una conversacion';
      loadAdminConversations(userId);
      renderReassignOptions(userId);

      document.getElementById('adminMessages').innerHTML = '<div class="welcome">Selecciona una conversacion</div>';
    });
  });

  async function loadAdminConversations(userId) {
    const container = document.getElementById('adminConvList');
    container.innerHTML = '<div class="muted" style="padding: 16px; text-align: center;">Cargando...</div>';
    setAdminStatus('');

    try {
      const res = await fetch(`/admin/conversations?user_id=${userId}`, { credentials: 'include' });
      if (!res.ok) throw new Error('No autorizado o error al cargar conversaciones');

      const convs = await res.json();

      if (convs.length === 0) {
        container.innerHTML = '<div class="muted" style="padding: 16px; text-align: center;">Sin conversaciones</div>';
        return;
      }

      container.innerHTML = '';
      convs.forEach(conv => {
        const div = document.createElement('div');
        div.className = 'admin-item';
        div.dataset.id = conv.id;
        div.innerHTML = `<strong>${conv.title || 'Sin titulo'}</strong><div class="meta">${new Date(conv.created_at).toLocaleDateString('es-ES')}</div>`;

        div.addEventListener('click', () => {
          adminSelectedConvId = conv.id;
          document.querySelectorAll('#adminConvList .admin-item').forEach(el => el.classList.remove('active'));
          div.classList.add('active');
          adminConvTitle.textContent = conv.title || `Conv ${conv.id}`;
          loadAdminMessages(conv.id);
        });

        container.appendChild(div);
      });
    } catch (err) {
      setAdminStatus(err.message || 'Error cargando conversaciones');
      container.innerHTML = `<div class="muted" style="padding: 16px; text-align: center;">Error: ${err.message}</div>`;
    }
  }

  async function loadAdminMessages(conversationId) {
    const container = document.getElementById('adminMessages');
    container.innerHTML = '<div class="welcome">Cargando mensajes...</div>';
    setAdminStatus('');

    try {
      const res = await fetch(`/admin/conversations/${conversationId}/messages?limit=400`, { credentials: 'include' });
      if (!res.ok) throw new Error('No autorizado o error al cargar mensajes');

      const messages = await res.json();

      if (messages.length === 0) {
        container.innerHTML = '<div class="welcome">Sin mensajes en esta conversacion</div>';
        return;
      }

      container.innerHTML = '';
      messages.forEach(msg => {
        const div = document.createElement('div');
        div.className = `msg ${msg.role}`;
        const roleLabel = msg.role === 'user' ? 'Usuario' : msg.role === 'assistant' ? 'Asistente' : 'Sistema';
        div.innerHTML = `
          <div class="meta">${roleLabel}</div>
          <div>${escapeHtml(msg.content).replace(/\\n/g, '<br>')}</div>
        `;
        container.appendChild(div);
      });

      container.scrollTop = container.scrollHeight;
    } catch (err) {
      setAdminStatus(err.message || 'Error cargando mensajes');
      container.innerHTML = `<div class="muted" style="padding: 16px;">Error: ${err.message}</div>`;
    }
  }

  async function renderReassignOptions(currentUserId) {
    const select = document.getElementById('reassignSelect');
    select.innerHTML = '<option value=\"\">Seleccionar usuario...</option>';

    try {
      const res = await fetch(`/admin/users`, { credentials: 'include' });
      if (!res.ok) throw new Error('No autorizado o error al cargar usuarios');

      const users = await res.json();
      users
        .filter(u => u.id != currentUserId)
        .forEach(u => {
          const opt = document.createElement('option');
          opt.value = u.id;
          opt.textContent = u.email;
          select.appendChild(opt);
        });
    } catch (err) {
      setAdminStatus(err.message || 'Error cargando usuarios para reasignar');
      console.error('Error loading users for reassign:', err);
    }
  }

  async function reassignConversation() {
    if (!adminSelectedConvId || !adminSelectedUserId) {
      alert('Selecciona una conversacion primero');
      return;
    }

    const targetUserId = document.getElementById('reassignSelect').value;
    if (!targetUserId) {
      alert('Selecciona un usuario destino');
      return;
    }

    try {
      const res = await fetch(`/admin/conversations/${adminSelectedConvId}/reassign`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ target_user_id: targetUserId })
      });

      if (!res.ok) {
        const error = await res.json().catch(() => ({}));
        throw new Error(error.detail || 'Reassign failed');
      }

      alert('Conversacion reasignada exitosamente');

      if (adminSelectedUserId) {
        loadAdminConversations(adminSelectedUserId);
      }
    } catch (err) {
      alert(`Error: ${err.message}`);
    }
  }
</script>
{% endblock %}
